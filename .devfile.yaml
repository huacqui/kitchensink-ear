schemaVersion: 2.2.0
metadata:
  name: kitchensink-ear-eap74-jdk8-devspaces325

components:
  # Maven cache persistente
  - name: m2
    volume:
      size: 10Gi

  # Datos EAP (logs/tmp/data/deployments) persistentes
  - name: eap-data
    volume:
      size: 10Gi

  # IDE / tooling (Dev Spaces 3.25)
  - name: development-tooling
    container:
      image: registry.redhat.io/devspaces/udi-rhel9:3.25.0
      memoryLimit: 6Gi
      cpuLimit: 4000m
      env:
        - name: MAVEN_OPTS
          value: "-Dmaven.repo.local=/home/user/.m2/repository"
      volumeMounts:
        - name: m2
          path: /home/user/.m2

  # Runtime EAP dentro del workspace
  - name: eap
    container:
      image: registry.redhat.io/jboss-eap-7/eap74-openjdk8-openshift-rhel8:7.4.23
      memoryLimit: 4Gi
      cpuLimit: 2000m

      # Importante: arrancar en modo "standalone.xml" (no standalone-openshift.xml)
      # y mover management fuera de 9990 para evitar el BindException.
      command: ["/bin/bash", "-lc"]
      args:
        - |
          set -euo pipefail
          echo "Starting EAP (standalone.xml) with management on 9991/9992 ..."
          exec /opt/eap/bin/standalone.sh \
            -c standalone.xml \
            -b 0.0.0.0 \
            -bmanagement 0.0.0.0

      env:
        # JVM opts: aquí forzamos management ports a 9991/9992
        # Nota: al usar standalone.sh directo, esta es la forma más consistente.
        - name: JAVA_OPTS
          value: >-
            -Xms512m -Xmx2048m
            -Djava.net.preferIPv4Stack=true
            -Djboss.management.http.port=9991
            -Djboss.management.native.port=9992

      volumeMounts:
        - name: eap-data
          path: /opt/eap/standalone/tmp
        - name: eap-data
          path: /opt/eap/standalone/data
        - name: eap-data
          path: /opt/eap/standalone/log
        - name: eap-data
          path: /opt/eap/standalone/deployments

      endpoints:
        - name: http
          targetPort: 8080
          exposure: public
          protocol: http
          path: /jboss-kitchensink-ear-web
          attributes:
            discoverable: "true"
            urlRewriteSupported: "true"

commands:
  - id: build-ear
    exec:
      component: development-tooling
      workingDir: /projects
      commandLine: |
        set -e
        cd /projects/kitchensink-ear 2>/dev/null || cd /projects
        mvn -B -DskipTests -pl ear -am clean package

  - id: deploy-ear
    exec:
      component: eap
      workingDir: /projects
      commandLine: |
        set -euo pipefail
        cd /projects/kitchensink-ear 2>/dev/null || cd /projects
        EAR="$(ls -1 ear/target/*.ear | head -n 1)"
        echo "Deploying: ${EAR}"
        DEPLOY_DIR="/opt/eap/standalone/deployments"
        cp -f "${EAR}" "${DEPLOY_DIR}/kitchensink.ear"
        # marker de deploy
        touch "${DEPLOY_DIR}/kitchensink.ear.dodeploy"
        echo "Done."

  - id: build-and-deploy
    composite:
      commands:
        - build-ear
        - deploy-ear

  - id: tail-eap-log
    exec:
      component: eap
      workingDir: /projects
      commandLine: |
        set -e
        tail -n 200 -f /opt/eap/standalone/log/server.log
